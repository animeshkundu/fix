name: Publish to Package Managers

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v0.1.0)'
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: false

env:
  PACKAGE_NAME: fix

jobs:
  # Submit to winget (microsoft/winget-pkgs - official repo)
  winget:
    name: Submit to winget
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get release info
        id: release
        shell: pwsh
        run: |
          $version = "${{ github.event.release.tag_name || github.event.inputs.version }}"
          $version = $version -replace '^v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Submit to winget
        uses: vedantmgoyal/winget-releaser@v2
        with:
          identifier: animeshkundu.fix
          version: ${{ steps.release.outputs.version }}
          installers-regex: 'fix-x86_64-pc-windows-msvc\.zip$'
          token: ${{ secrets.WINGET_TOKEN }}
        continue-on-error: true  # Don't fail release if winget submission fails

  # Publish to Chocolatey (direct push to chocolatey.org)
  chocolatey:
    name: Publish to Chocolatey
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get release info
        id: release
        shell: pwsh
        run: |
          $version = "${{ github.event.release.tag_name || github.event.inputs.version }}"
          $version = $version -replace '^v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Download release artifact for hash
        shell: pwsh
        run: |
          $tag = "${{ github.event.release.tag_name || github.event.inputs.version }}"
          Invoke-WebRequest -Uri "https://github.com/animeshkundu/fix/releases/download/$tag/fix-x86_64-pc-windows-msvc.zip" -OutFile "fix.zip"
          $hash = (Get-FileHash -Path "fix.zip" -Algorithm SHA256).Hash.ToLower()
          echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        id: hash

      - name: Create Chocolatey package
        shell: pwsh
        run: |
          # Create package directory structure
          New-Item -ItemType Directory -Path "chocolatey/tools" -Force

          # Create nuspec
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
            <metadata>
              <id>fix-cli</id>
              <version>${{ steps.release.outputs.version }}</version>
              <title>fix - AI Shell Command Corrector</title>
              <authors>Animesh Kundu</authors>
              <owners>animeshkundu</owners>
              <projectUrl>https://github.com/animeshkundu/fix</projectUrl>
              <licenseUrl>https://github.com/animeshkundu/fix/blob/main/LICENSE</licenseUrl>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <description>AI-powered shell command corrector using a local LLM. Fix typos in your shell commands instantly.</description>
              <summary>Fix shell command typos with AI</summary>
              <tags>cli shell command-line ai llm typo correction</tags>
            </metadata>
          </package>
          "@ | Out-File -Encoding utf8 "chocolatey/fix-cli.nuspec"

          # Create install script
          $tag = "${{ github.event.release.tag_name || github.event.inputs.version }}"
          @"
          `$ErrorActionPreference = 'Stop'
          `$toolsDir = "`$(Split-Path -Parent `$MyInvocation.MyCommand.Definition)"
          `$packageArgs = @{
            packageName   = 'fix-cli'
            url64         = 'https://github.com/animeshkundu/fix/releases/download/$tag/fix-x86_64-pc-windows-msvc.zip'
            checksum64    = '${{ steps.hash.outputs.sha256 }}'
            checksumType64= 'sha256'
            unzipLocation = `$toolsDir
          }
          Install-ChocolateyZipPackage @packageArgs
          "@ | Out-File -Encoding utf8 "chocolatey/tools/chocolateyinstall.ps1"

          # Pack
          choco pack chocolatey/fix-cli.nuspec --out chocolatey

      - name: Push to Chocolatey
        shell: pwsh
        run: |
          choco apikey --key ${{ secrets.CHOCOLATEY_API_KEY }} --source https://push.chocolatey.org/
          choco push chocolatey/fix-cli.${{ steps.release.outputs.version }}.nupkg --source https://push.chocolatey.org/
        continue-on-error: true

  # Summary job
  summary:
    name: Package Publishing Summary
    runs-on: ubuntu-latest
    needs: [winget, chocolatey]
    if: always()
    steps:
      - name: Report status
        run: |
          echo "## Package Manager Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package Manager | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| winget | ${{ needs.winget.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chocolatey | ${{ needs.chocolatey.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets Required" >> $GITHUB_STEP_SUMMARY
          echo "- \`WINGET_TOKEN\`: GitHub PAT with public_repo scope" >> $GITHUB_STEP_SUMMARY
          echo "- \`CHOCOLATEY_API_KEY\`: From chocolatey.org account" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Package managers may take time to process submissions." >> $GITHUB_STEP_SUMMARY
