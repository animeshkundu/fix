name: Installation Tests

on:
  push:
    branches: [main]
    paths:
      - 'website/install.sh'
      - 'website/install.ps1'
      - '.github/workflows/test-install.yml'
  pull_request:
    branches: [main]
    paths:
      - 'website/install.sh'
      - 'website/install.ps1'
      - '.github/workflows/test-install.yml'

jobs:
  test-install-script-linux:
    name: Test install.sh (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Test script syntax
      - name: Check script syntax
        run: bash -n website/install.sh

      # Test helper functions work
      - name: Test OS detection function
        run: |
          # Define the function directly to avoid sed compatibility issues
          detect_os() {
            case "$(uname -s)" in
              Darwin) echo "macos" ;;
              Linux) echo "linux" ;;
              MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
              *) echo "unsupported" ;;
            esac
          }
          result=$(detect_os)
          echo "Detected OS: $result"
          [ "$result" = "linux" ] || exit 1

      - name: Test architecture detection function
        run: |
          # Define the function directly
          detect_arch() {
            case "$(uname -m)" in
              x86_64|amd64) echo "x86_64" ;;
              arm64|aarch64) echo "aarch64" ;;
              *) echo "unsupported" ;;
            esac
          }
          result=$(detect_arch)
          echo "Detected arch: $result"
          [ "$result" = "x86_64" ] || [ "$result" = "aarch64" ] || exit 1

      # Test install directory creation
      - name: Test install directory creation
        run: |
          mkdir -p "$HOME/.local/bin"
          [ -d "$HOME/.local/bin" ] || exit 1
          echo "Install directory created successfully"

      # Test model directory creation
      - name: Test model directory creation
        run: |
          mkdir -p "$HOME/.config/fix"
          [ -d "$HOME/.config/fix" ] || exit 1
          echo "Model directory created successfully"

      # Simulate binary installation (without actual download)
      - name: Simulate binary installation
        run: |
          # Create a mock binary
          echo '#!/bin/bash' > "$HOME/.local/bin/fix"
          echo 'echo "git status"' >> "$HOME/.local/bin/fix"
          chmod +x "$HOME/.local/bin/fix"

          # Verify binary works
          result=$("$HOME/.local/bin/fix" "gti status")
          echo "Mock binary output: $result"
          [ "$result" = "git status" ] || exit 1

  test-install-script-macos:
    name: Test install.sh (macOS)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Check script syntax
        run: bash -n website/install.sh

      - name: Test OS detection function
        run: |
          # Define the function directly (macOS sed has different behavior)
          detect_os() {
            case "$(uname -s)" in
              Darwin) echo "macos" ;;
              Linux) echo "linux" ;;
              MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
              *) echo "unsupported" ;;
            esac
          }
          result=$(detect_os)
          echo "Detected OS: $result"
          [ "$result" = "macos" ] || exit 1

      - name: Test architecture detection function
        run: |
          # Define the function directly
          detect_arch() {
            case "$(uname -m)" in
              x86_64|amd64) echo "x86_64" ;;
              arm64|aarch64) echo "aarch64" ;;
              *) echo "unsupported" ;;
            esac
          }
          result=$(detect_arch)
          echo "Detected arch: $result"
          [ "$result" = "aarch64" ] || exit 1

      - name: Test install directory creation
        run: |
          mkdir -p "$HOME/.local/bin"
          [ -d "$HOME/.local/bin" ] || exit 1

      # Test macOS model path (Library/Application Support)
      - name: Test macOS config directory
        run: |
          # The CLI uses dirs::config_dir() which on macOS is ~/Library/Application Support
          config_dir="$HOME/Library/Application Support/fix"
          mkdir -p "$config_dir"
          [ -d "$config_dir" ] || exit 1
          echo "macOS config directory created: $config_dir"

  test-install-ps1-windows:
    name: Test install.ps1 (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # Test PowerShell script syntax
      - name: Check script syntax
        shell: pwsh
        run: |
          $errors = $null
          $ast = [System.Management.Automation.Language.Parser]::ParseFile(
            "website/install.ps1",
            [ref]$null,
            [ref]$errors
          )
          if ($errors.Count -gt 0) {
            $errors | ForEach-Object { Write-Error $_.Message }
            exit 1
          }
          Write-Host "PowerShell script syntax is valid"

      # Test architecture detection
      - name: Test architecture detection
        shell: pwsh
        run: |
          $arch = if ([Environment]::Is64BitOperatingSystem) { "x86_64" } else { "i686" }
          Write-Host "Detected architecture: $arch"
          if ($arch -ne "x86_64") {
            Write-Error "Expected x86_64 on GitHub runner"
            exit 1
          }

      # Test install directory creation
      - name: Test install directory creation
        shell: pwsh
        run: |
          $installDir = "$env:LOCALAPPDATA\fix"
          New-Item -ItemType Directory -Path $installDir -Force | Out-Null
          if (-not (Test-Path $installDir)) {
            Write-Error "Failed to create install directory"
            exit 1
          }
          Write-Host "Install directory created: $installDir"

      # Test model directory creation (APPDATA)
      - name: Test model directory creation
        shell: pwsh
        run: |
          $modelDir = "$env:APPDATA\fix"
          New-Item -ItemType Directory -Path $modelDir -Force | Out-Null
          if (-not (Test-Path $modelDir)) {
            Write-Error "Failed to create model directory"
            exit 1
          }
          Write-Host "Model directory created: $modelDir"

      # Test PATH modification logic
      - name: Test PATH modification
        shell: pwsh
        run: |
          $installDir = "$env:LOCALAPPDATA\fix"
          $testPath = "C:\existing\path;C:\another\path"

          # Test that we can detect if path is not in PATH
          if ($testPath -notlike "*$installDir*") {
            Write-Host "Correctly detected install dir not in PATH"
          } else {
            Write-Error "PATH detection logic failed"
            exit 1
          }

          # Test that we can detect if path IS in PATH
          $testPath2 = "$testPath;$installDir"
          if ($testPath2 -like "*$installDir*") {
            Write-Host "Correctly detected install dir in PATH"
          } else {
            Write-Error "PATH detection logic failed"
            exit 1
          }

      # Test profile path detection
      - name: Test profile path detection
        shell: pwsh
        run: |
          $profilePath = $PROFILE.CurrentUserCurrentHost
          Write-Host "PowerShell profile path: $profilePath"
          if (-not $profilePath) {
            Write-Error "Could not determine profile path"
            exit 1
          }

      # Simulate binary installation
      - name: Simulate binary installation
        shell: pwsh
        run: |
          $installDir = "$env:LOCALAPPDATA\fix"
          $exePath = "$installDir\fix.exe"

          # Create a mock executable (batch file renamed to .exe won't work, so just test path)
          "mock" | Out-File -FilePath $exePath

          if (Test-Path $exePath) {
            Write-Host "Mock binary created at: $exePath"
          } else {
            Write-Error "Failed to create mock binary"
            exit 1
          }

  test-install-wsl:
    name: Test install.sh (WSL)
    runs-on: windows-latest
    steps:
      - name: Configure git for LF line endings
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - uses: actions/checkout@v4

      - name: Setup WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-22.04

      # Test WSL detection in the script
      - name: Test WSL detection
        shell: wsl-bash {0}
        run: |
          # The is_wsl function from install.sh
          is_wsl() {
            grep -qiE "(microsoft|wsl)" /proc/version 2>/dev/null
          }

          if is_wsl; then
            echo "Correctly detected WSL environment"
          else
            echo "ERROR: Should have detected WSL"
            exit 1
          fi

      - name: Check script syntax in WSL
        shell: wsl-bash {0}
        run: bash -n website/install.sh

      - name: Test OS detection in WSL
        shell: wsl-bash {0}
        run: |
          # Source the detect_os function
          detect_os() {
            case "$(uname -s)" in
              Darwin) echo "macos" ;;
              Linux) echo "linux" ;;
              MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
              *) echo "unsupported" ;;
            esac
          }

          result=$(detect_os)
          echo "Detected OS in WSL: $result"
          [ "$result" = "linux" ] || exit 1

      - name: Test install directories in WSL
        shell: wsl-bash {0}
        run: |
          mkdir -p "$HOME/.local/bin"
          mkdir -p "$HOME/.config/fix"

          [ -d "$HOME/.local/bin" ] || exit 1
          [ -d "$HOME/.config/fix" ] || exit 1

          echo "WSL install directories created successfully"
          echo "Binary would go to: $HOME/.local/bin/fix"
          echo "Model would go to: $HOME/.config/fix/"

  test-shell-integration:
    name: Test Shell Integration Functions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Test bash function syntax
      - name: Test bash function
        run: |
          # Test a simple bash function to verify syntax
          bash -c '
          fix() {
              if [[ -n "$1" ]]; then
                  echo "direct: $@"
              else
                  echo "No args"
              fi
          }
          result=$(fix "test command")
          echo "Result: $result"
          [[ "$result" == "direct: test command" ]] || exit 1
          '
          echo "Bash function syntax is valid"

      # Test zsh function syntax
      - name: Test zsh function
        run: |
          # Install zsh if needed
          sudo apt-get update && sudo apt-get install -y zsh

          # Test zsh function
          zsh -c '
          fix() {
              if [[ -n "$1" ]]; then
                  echo "direct: $@"
              else
                  echo "No args"
              fi
          }
          result=$(fix "test command")
          [[ "$result" == "direct: test command" ]] || exit 1
          '
          echo "Zsh function syntax is valid"

      # Test fish function syntax
      - name: Test fish function
        run: |
          # Install fish
          sudo apt-get install -y fish

          # Test fish function
          fish -c '
          function fix --description "Fix the last command"
              if test (count $argv) -gt 0
                  echo "direct: $argv"
              else
                  echo "No correction needed"
              end
          end
          fix "test command"
          ' | grep -q "direct: test command"
          echo "Fish function syntax is valid"
