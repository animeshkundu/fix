name: E2E Tests Matrix

on:
  push:
    branches: [main]
    paths:
      - 'fix-cli/**'
      - '.github/workflows/test-e2e-matrix.yml'
  pull_request:
    branches: [main]
    paths:
      - 'fix-cli/**'
      - '.github/workflows/test-e2e-matrix.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  # fix model (0.6B - ~378MB)
  FIX_MODEL_NAME: qwen3-correct-0.6B.gguf
  FIX_MODEL_URL: https://huggingface.co/animeshkundu/cmd-correct/resolve/main/qwen3-correct-0.6B.gguf
  # wit model (1.7B - ~1GB)
  WIT_MODEL_NAME: qwen3-wit-1.7B.gguf
  WIT_MODEL_URL: https://huggingface.co/animeshkundu/cmd-correct/resolve/main/qwen3-wit-1.7B.gguf

jobs:
  # Build binaries for all platforms first
  build-binaries:
    uses: ./.github/workflows/build-binaries.yml

  # Download both models once and share via artifact
  download-models:
    name: Download Models
    runs-on: ubuntu-latest
    steps:
      - name: Cache models
        id: cache
        uses: actions/cache@v4
        with:
          path: model-cache
          key: models-fix-0.6B-wit-1.7B-v1

      - name: Download fix model if not cached
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p model-cache
          echo "Downloading fix model (378MB)..."
          curl -fSL --progress-bar "$FIX_MODEL_URL" -o "model-cache/$FIX_MODEL_NAME"

      - name: Download wit model if not cached
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "Downloading wit model (1GB)..."
          curl -fSL --progress-bar "$WIT_MODEL_URL" -o "model-cache/$WIT_MODEL_NAME"

      - name: Validate model sizes
        run: |
          FIX_SIZE=$(stat -c%s "model-cache/$FIX_MODEL_NAME" 2>/dev/null || stat -f%z "model-cache/$FIX_MODEL_NAME")
          WIT_SIZE=$(stat -c%s "model-cache/$WIT_MODEL_NAME" 2>/dev/null || stat -f%z "model-cache/$WIT_MODEL_NAME")
          echo "fix model: $FIX_SIZE bytes"
          echo "wit model: $WIT_SIZE bytes"
          [ "$FIX_SIZE" -gt 300000000 ] || (echo "fix model too small" && exit 1)
          [ "$WIT_SIZE" -gt 900000000 ] || (echo "wit model too small" && exit 1)
          ls -lh model-cache/

      - name: Upload models artifact
        uses: actions/upload-artifact@v4
        with:
          name: models
          path: model-cache/
          retention-days: 1

  # E2E test matrix across OS and shell combinations
  e2e-test:
    name: E2E (${{ matrix.os }}, ${{ matrix.shell }})
    needs: [build-binaries, download-models]
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS with Metal GPU
          - os: macos-14
            target: aarch64-apple-darwin
            shell: zsh
            config_path: ~/Library/Application Support/fix
          - os: macos-14
            target: aarch64-apple-darwin
            shell: bash
            config_path: ~/Library/Application Support/fix

          # Linux (CPU only)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            shell: bash
            config_path: ~/.config/fix
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            shell: zsh
            config_path: ~/.config/fix
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            shell: fish
            config_path: ~/.config/fix
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            shell: tcsh
            config_path: ~/.config/fix

          # Windows (CPU only)
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            shell: powershell
            config_path: $env:APPDATA\fix

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: fix-cli

      - name: Download pre-built binary
        uses: actions/download-artifact@v4
        with:
          name: fix-binary-${{ matrix.target }}
          path: binary-download

      - name: Download models artifact
        uses: actions/download-artifact@v4
        with:
          name: models
          path: model-download

      # Setup model paths - Unix (Linux)
      - name: Setup models (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p ~/.config/fix
          cp model-download/${{ env.FIX_MODEL_NAME }} ~/.config/fix/
          cp model-download/${{ env.WIT_MODEL_NAME }} ~/.config/fix/
          ls -lh ~/.config/fix/

      # Setup model paths - macOS
      - name: Setup models (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p "$HOME/Library/Application Support/fix"
          cp model-download/${{ env.FIX_MODEL_NAME }} "$HOME/Library/Application Support/fix/"
          cp model-download/${{ env.WIT_MODEL_NAME }} "$HOME/Library/Application Support/fix/"
          ls -lh "$HOME/Library/Application Support/fix/"

      # Setup model paths - Windows
      - name: Setup models (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$env:APPDATA\fix" -Force | Out-Null
          Copy-Item "model-download/${{ env.FIX_MODEL_NAME }}" "$env:APPDATA\fix\"
          Copy-Item "model-download/${{ env.WIT_MODEL_NAME }}" "$env:APPDATA\fix\"
          Get-ChildItem "$env:APPDATA\fix"

      # Install shells if needed (Linux)
      - name: Install zsh
        if: matrix.shell == 'zsh' && runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Install fish
        if: matrix.shell == 'fish' && runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y fish

      - name: Install tcsh
        if: matrix.shell == 'tcsh' && runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y tcsh

      # Setup pre-built binary
      - name: Setup binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p fix-cli/target/release
          cp binary-download/fix-${{ matrix.target }} fix-cli/target/release/fix
          cp binary-download/wit-${{ matrix.target }} fix-cli/target/release/wit
          chmod +x fix-cli/target/release/fix
          chmod +x fix-cli/target/release/wit
          echo "Binary ready at fix-cli/target/release/fix"
          fix-cli/target/release/fix --help | head -5
          echo "Binary ready at fix-cli/target/release/wit"
          fix-cli/target/release/wit --help | head -5

      - name: Setup binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path fix-cli/target/release -Force | Out-Null
          Copy-Item binary-download/fix-${{ matrix.target }}.exe fix-cli/target/release/fix.exe
          Copy-Item binary-download/wit-${{ matrix.target }}.exe fix-cli/target/release/wit.exe
          Write-Host "Binary ready at fix-cli/target/release/fix.exe"
          & fix-cli/target/release/fix.exe --help | Select-Object -First 5
          Write-Host "Binary ready at fix-cli/target/release/wit.exe"
          & fix-cli/target/release/wit.exe --help | Select-Object -First 5

      # Run E2E tests (these require building the test harness, but not the binary)
      - name: Run E2E tests (Unix)
        if: runner.os != 'Windows'
        working-directory: fix-cli
        run: cargo test --test e2e_test -- --ignored --test-threads=1
        env:
          SHELL: /bin/${{ matrix.shell }}

      - name: Run E2E tests (Windows)
        if: runner.os == 'Windows'
        working-directory: fix-cli
        shell: pwsh
        run: cargo test --test e2e_test -- --ignored --test-threads=1

      # Run wit E2E tests (basic tests don't require #[ignore] flag, agentic tests do)
      - name: Run wit E2E tests (Unix)
        if: runner.os != 'Windows'
        working-directory: fix-cli
        run: |
          # Run basic wit tests (help, config, etc.)
          cargo test --test e2e_wit_test -- --test-threads=1 || echo "Some basic wit tests skipped"
          # Run agentic wit E2E tests (require model)
          cargo test --test e2e_wit_test -- --ignored --test-threads=1 || echo "Some agentic wit E2E tests skipped"
        env:
          SHELL: /bin/${{ matrix.shell }}

      - name: Run wit E2E tests (Windows)
        if: runner.os == 'Windows'
        working-directory: fix-cli
        shell: pwsh
        run: |
          # Run basic wit tests
          cargo test --test e2e_wit_test -- --test-threads=1
          if ($LASTEXITCODE -ne 0) { Write-Host "Some basic wit tests skipped" }
          # Run agentic wit E2E tests
          cargo test --test e2e_wit_test -- --ignored --test-threads=1
          if ($LASTEXITCODE -ne 0) { Write-Host "Some agentic wit E2E tests skipped" }

      # Test wit binary
      - name: Test wit binary (Unix)
        if: runner.os != 'Windows'
        working-directory: fix-cli
        run: |
          echo "Testing wit binary..."
          if [ -x ./target/release/wit ]; then
            echo "wit binary exists and is executable"
            ./target/release/wit --help | head -5
            echo "PASS: wit binary is functional"
          else
            echo "FAIL: wit binary missing or not executable"
            exit 1
          fi

      - name: Test wit binary (Windows)
        if: runner.os == 'Windows'
        working-directory: fix-cli
        shell: pwsh
        run: |
          Write-Host "Testing wit binary..."
          if (Test-Path ./target/release/wit.exe) {
            Write-Host "wit binary exists"
            & ./target/release/wit.exe --help | Select-Object -First 5
            Write-Host "PASS: wit binary is functional"
          } else {
            Write-Host "FAIL: wit binary missing"
            exit 1
          }
