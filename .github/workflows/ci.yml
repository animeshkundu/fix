name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fix-cli
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fix-cli
      - name: Check formatting
        run: cargo fmt --check
      - name: Clippy
        run: cargo clippy -- -D warnings

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            features: metal
          - os: macos-15
            features: metal
          - os: ubuntu-latest
            features: ""
          - os: windows-latest
            features: ""
    defaults:
      run:
        working-directory: fix-cli
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fix-cli
      - name: Build
        run: cargo build --release ${{ matrix.features && format('--features {0}', matrix.features) || '' }}
      - name: Verify binaries exist (Unix)
        if: runner.os != 'Windows'
        run: |
          if [ -f target/release/fix ] && [ -f target/release/wit ]; then
            echo "✓ Both fix and wit binaries built successfully"
          else
            echo "✗ Missing binaries"
            exit 1
          fi
      - name: Verify binaries exist (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ((Test-Path target/release/fix.exe) -and (Test-Path target/release/wit.exe)) {
            Write-Host "✓ Both fix and wit binaries built successfully"
          } else {
            Write-Host "✗ Missing binaries"
            exit 1
          }

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            features: metal
          - os: ubuntu-latest
            features: ""
          - os: windows-latest
            features: ""
    defaults:
      run:
        working-directory: fix-cli
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fix-cli
      - name: Run tests
        run: cargo test ${{ matrix.features && format('--features {0}', matrix.features) || '' }} -- --test-threads=1

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: fix-cli
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: fix-cli

      # Cache the model to avoid re-downloading
      - name: Cache model
        uses: actions/cache@v4
        with:
          path: ~/.config/fix/qwen3-correct-0.6B.gguf
          key: model-qwen3-correct-0.6B-v1

      - name: Build release
        run: cargo build --release

      - name: Download model if not cached
        run: |
          mkdir -p ~/.config/fix
          if [ ! -f ~/.config/fix/qwen3-correct-0.6B.gguf ]; then
            echo "Downloading model..."
            curl -fSL --progress-bar \
              "https://huggingface.co/animeshkundu/cmd-correct/resolve/main/qwen3-correct-0.6B.gguf" \
              -o ~/.config/fix/qwen3-correct-0.6B.gguf
          else
            echo "Model already cached"
          fi

      - name: Run E2E tests
        run: cargo test --test e2e_test -- --ignored --test-threads=1

      - name: Quick inference test
        run: |
          result=$(./target/release/fix "gti status" 2>/dev/null)
          echo "Input: gti status"
          echo "Output: $result"
          if [ "$result" = "git status" ]; then
            echo "E2E inference test PASSED"
          else
            echo "E2E inference test FAILED"
            exit 1
          fi

      - name: Test wit binary exists
        run: |
          if [ -x ./target/release/wit ]; then
            echo "wit binary exists and is executable"
            ./target/release/wit --help | head -5
          else
            echo "wit binary missing or not executable"
            exit 1
          fi
